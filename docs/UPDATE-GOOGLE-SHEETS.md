# 🔄 Google Sheets 更新指南 - 分组功能支持

## 📋 更新概述

由于新增了**分组测验功能**，Google Sheets 的数据结构需要更新以支持存储各组的得分信息。

## ⚠️ 重要提示

如果你已经部署了 Google Sheets + Apps Script，需要按照以下步骤更新：

---

## 🔧 更新步骤

### 第一步：更新 Google Sheets 列结构

在你的 Google Sheets 中添加新列：

**在 K1 单元格添加列头：**
```
K1: 分组得分详情
```

> 💡 **说明**：这一列将以 JSON 格式存储各组的得分信息

**完整的列结构应该是：**
```
A: 提交时间
B: 用户姓名
C: 总分
D: 满分
E: 结果等级
F: 客观题得分
G: 简答题得分
H: 简答题反馈
I: 错题详情
J: 原始答案数据
K: 分组得分详情  ← 新增
```

---

### 第二步：更新 Apps Script 代码

1. **打开 Apps Script 编辑器**
   - 在你的 Google Sheets 中，点击 **扩展程序** → **Apps Script**

2. **替换代码**
   - 复制 `docs/apps-script-code.js` 的最新内容
   - 在 Apps Script 编辑器中**完全替换**原有代码
   - 保存（Ctrl/Cmd + S）

3. **重新部署**
   - 点击右上角 **部署** → **管理部署**
   - 点击现有部署右侧的 **编辑** 图标（铅笔图标）
   - 在"版本"下拉菜单中选择 **新版本**
   - 添加版本说明：`支持分组得分功能`
   - 点击 **部署**

> ⚠️ **注意**：不要创建新部署，而是编辑现有部署并选择"新版本"，这样 URL 不会改变

---

### 第三步：测试更新

1. **重启你的 Next.js 应用**
   ```bash
   npm run dev
   ```

2. **进行一次测验提交**
   - 访问 `http://localhost:3000`
   - 完成测验并提交

3. **检查 Google Sheets**
   - 查看 K 列是否有数据
   - 数据格式应该类似：
     ```json
     [
       {
         "groupId": "group1",
         "title": "AI技术应用基础",
         "score": 8,
         "totalPoints": 10,
         "resultText": "优秀 ✨"
       },
       {
         "groupId": "group2",
         "title": "AI产品流程和实践",
         "score": 2,
         "totalPoints": 2,
         "resultText": "优秀 ✨"
       }
     ]
     ```

4. **测试 CSV 导出**
   - 访问管理员页面 `/admin`
   - 点击"导出 CSV"
   - 检查导出的 CSV 是否包含新的分组得分列：
     - 第1组得分
     - 第1组总分
     - 第1组结果
     - 第2组得分
     - 第2组总分
     - 第2组结果

---

## 📊 新增的数据字段

### K列：分组得分详情（JSON格式）

存储格式：
```json
[
  {
    "groupId": "group1",
    "title": "AI技术应用基础",
    "score": 8,
    "totalPoints": 10,
    "resultText": "优秀 ✨"
  },
  {
    "groupId": "group2",
    "title": "AI产品流程和实践",
    "score": 2,
    "totalPoints": 2,
    "resultText": "通过 👍"
  }
]
```

### CSV 导出新增列

导出 CSV 时，JSON 数据会被展开为以下列：
- **第1组得分**：第1组获得的分数
- **第1组总分**：第1组的满分
- **第1组结果**：优秀 ✨ / 通过 👍 / 不通过 🔴
- **第2组得分**：第2组获得的分数
- **第2组总分**：第2组的满分
- **第2组结果**：优秀 ✨ / 通过 👍 / 不通过 🔴

---

## 🎯 评分规则说明

### 单组评分
- **优秀 ✨**：得分率 ≥ 80%
- **通过 👍**：得分率 ≥ 60%
- **不通过 🔴**：得分率 < 60%

### 最终结果判定
- **优秀 ✨**：所有组都是"优秀"
- **通过 👍**：所有组都是"通过"或"优秀"
- **不通过 🔴**：至少有一组不通过

---

## ❓ 常见问题

### Q1: 旧数据会受影响吗？
**A:** 不会。旧数据的 K 列会是空的，不影响查看和导出。新提交的数据会自动填充 K 列。

### Q2: 必须重新部署 Apps Script 吗？
**A:** 是的，必须更新代码并重新部署，否则新的分组得分数据无法保存。

### Q3: 重新部署后 URL 会变吗？
**A:** 不会。只要你是"编辑现有部署"并选择"新版本"，URL 保持不变。

### Q4: 如何验证更新成功？
**A:** 提交一次测验后，检查：
1. Google Sheets 的 K 列有 JSON 数据
2. CSV 导出包含 6 个新列（第1组得分、第1组总分、第1组结果、第2组得分、第2组总分、第2组结果）
3. 管理员页面能正常显示分组得分

### Q5: 更新失败怎么办？
**A:** 
1. 检查 Apps Script 代码是否完整复制
2. 确认选择了"新版本"而不是创建新部署
3. 查看 Apps Script 的执行日志（查看 → 执行）
4. 检查浏览器控制台是否有错误

---

## 📝 更新检查清单

完成以下检查确保更新成功：

- [ ] Google Sheets 添加了 K1 列头"分组得分详情"
- [ ] Apps Script 代码已更新为最新版本
- [ ] 已重新部署（选择"新版本"）
- [ ] 测试提交后 K 列有 JSON 数据
- [ ] CSV 导出包含 6 个新的分组得分列
- [ ] 管理员页面显示正常

---

## 🎉 更新完成

恭喜！你的 Google Sheets 现在支持分组测验功能了！

如有问题，请查看：
- `docs/google-sheets-setup.md` - 完整设置指南
- `docs/apps-script-code.js` - 最新的 Apps Script 代码
- `README-GOOGLE-SHEETS.md` - 功能说明文档

